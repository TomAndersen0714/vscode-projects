CREATE TABLE xd_data.web_log_kudu (
    day INT NOT NULL ENCODING AUTO_ENCODING COMPRESSION DEFAULT_COMPRESSION,
    track_id STRING NOT NULL ENCODING AUTO_ENCODING COMPRESSION DEFAULT_COMPRESSION,
    app_id STRING NULL ENCODING AUTO_ENCODING COMPRESSION DEFAULT_COMPRESSION
    PRIMARY KEY (day, track_id)
) 
PARTITION BY HASH (day, track_id) PARTITIONS 4 
STORED AS KUDU 
TBLPROPERTIES (
    'kudu.master_addresses' = 'cdh0,cdh1,cdh2'
)


DROP TABLE IF EXISTS tmp.kudu_data_type_test
CREATE TABLE tmp.kudu_data_type_test (
    integer_type INTEGER,
    bigint_type BIGINT,
    tiny_int TINYINT,
    smallint_type SMALLINT,
    int_type INT,
    bool_type BOOLEAN,
    float_type FLOAT,
    double_type DOUBLE,
    string_type STRING,
    time_type TIMESTAMP,
    varchar_type VARCHAR,
    PRIMARY KEY (integer_type)
)
PARTITION BY HASH(integer_type) PARTITIONS 4
STORED AS KUDU 
TBLPROPERTIES (
    'kudu.master_addresses' = 'cdh0,cdh1,cdh2'
)

UPSERT INTO tmp.kudu_data_type_test VALUES(
    1,1,1,1,1,True,1.2,1.1,'Tom','2021-08-06','Andersen'
)
UPSERT INTO tmp.kudu_data_type_test VALUES(
    2,1,1,1,1,True,1.2,1.1,'Tom','2021-08-06','Andersen'
)

UPSERT INTO tmp.kudu_data_type_test(integer_type,float_type,double_type)
SELECT int_type, float_type, double_type
FROM tmp.hive_type_test_tbl


DROP TABLE IF EXISTS tmp.kudu_data_type_test_1
CREATE TABLE tmp.kudu_data_type_test_1 (
    integer_type INTEGER,
    bigint_type BIGINT,
    tiny_int TINYINT,
    smallint_type SMALLINT,
    int_type INT,
    bool_type BOOLEAN,
    float_type FLOAT,
    double_type DOUBLE,
    string_type STRING,
    time_type TIMESTAMP,
    varchar_type VARCHAR,
    PRIMARY KEY (integer_type)
)
PARTITION BY HASH(integer_type) PARTITIONS 4
STORED AS KUDU 
TBLPROPERTIES (
    'kudu.master_addresses' = 'cdh0,cdh1,cdh2'
)


CREATE TABLE tmp.reminder_order_kudu (
    reminder_day INT NOT NULL ENCODING AUTO_ENCODING COMPRESSION DEFAULT_COMPRESSION DEFAULT 0,
    shop_id STRING NOT NULL ENCODING AUTO_ENCODING COMPRESSION DEFAULT_COMPRESSION,
    node_type STRING NOT NULL ENCODING AUTO_ENCODING COMPRESSION DEFAULT_COMPRESSION,
    tid STRING NOT NULL ENCODING AUTO_ENCODING COMPRESSION DEFAULT_COMPRESSION,
    subnick STRING NOT NULL ENCODING AUTO_ENCODING COMPRESSION DEFAULT_COMPRESSION,
    buyer_nick STRING NOT NULL ENCODING AUTO_ENCODING COMPRESSION DEFAULT_COMPRESSION,
    create_time STRING NOT NULL ENCODING AUTO_ENCODING COMPRESSION DEFAULT_COMPRESSION,
    task_id STRING NOT NULL ENCODING AUTO_ENCODING COMPRESSION DEFAULT_COMPRESSION,
    task_name STRING NOT NULL ENCODING AUTO_ENCODING COMPRESSION DEFAULT_COMPRESSION,
    conversion_tid STRING NULL ENCODING AUTO_ENCODING COMPRESSION DEFAULT_COMPRESSION,
    is_silence BOOLEAN NULL ENCODING AUTO_ENCODING COMPRESSION DEFAULT_COMPRESSION DEFAULT FALSE,
    conversion_value BIGINT NULL ENCODING AUTO_ENCODING COMPRESSION DEFAULT_COMPRESSION DEFAULT 0,
    conversion_time STRING NULL ENCODING AUTO_ENCODING COMPRESSION DEFAULT_COMPRESSION DEFAULT '',
    PRIMARY KEY (reminder_day,shop_id,node_type,tid,subnick,buyer_nick,create_time,task_id,task_name)
) PARTITION BY HASH (shop_id) PARTITIONS 4,
RANGE (reminder_day) (
    PARTITION 20210807<=VALUES<20210808,
    PARTITION 20210808<=VALUES<20210809,
    PARTITION 20210809<=VALUES<20210810
) 
STORED AS KUDU TBLPROPERTIES (
    'kudu.master_addresses' = 'v1mini-bigdata-002,v1mini-bigdata-003,mini-bigdata-004'
)



CREATE TABLE tmp.reminder_order_kudu_test (
  reminder_day INT NOT NULL ENCODING AUTO_ENCODING COMPRESSION DEFAULT_COMPRESSION DEFAULT 0,
  PRIMARY KEY (reminder_day)
)
PARTITION BY HASH (reminder_day) PARTITIONS 4, 
RANGE (reminder_day) (
    PARTITION 20210802<=VALUES<20210803,
    PARTITION 20210803<=VALUES<20210804
) STORED AS KUDU
TBLPROPERTIES ('kudu.master_addresses' = 'cdh0,cdh1,cdh2')


CREATE TABLE tmp.reminder_order_kudu_bck (
    reminder_day INT NOT NULL ENCODING AUTO_ENCODING COMPRESSION DEFAULT_COMPRESSION DEFAULT 0,
    shop_id STRING NOT NULL ENCODING AUTO_ENCODING COMPRESSION DEFAULT_COMPRESSION,
    node_type STRING NOT NULL ENCODING AUTO_ENCODING COMPRESSION DEFAULT_COMPRESSION,
    tid STRING NOT NULL ENCODING AUTO_ENCODING COMPRESSION DEFAULT_COMPRESSION,
    subnick STRING NOT NULL ENCODING AUTO_ENCODING COMPRESSION DEFAULT_COMPRESSION,
    buyer_nick STRING NOT NULL ENCODING AUTO_ENCODING COMPRESSION DEFAULT_COMPRESSION,
    create_time STRING NOT NULL ENCODING AUTO_ENCODING COMPRESSION DEFAULT_COMPRESSION,
    task_id STRING NOT NULL ENCODING AUTO_ENCODING COMPRESSION DEFAULT_COMPRESSION,
    task_name STRING NOT NULL ENCODING AUTO_ENCODING COMPRESSION DEFAULT_COMPRESSION,
    conversion_tid STRING NULL ENCODING AUTO_ENCODING COMPRESSION DEFAULT_COMPRESSION,
    is_silence BOOLEAN NULL ENCODING AUTO_ENCODING COMPRESSION DEFAULT_COMPRESSION DEFAULT FALSE,
    conversion_value BIGINT NULL ENCODING AUTO_ENCODING COMPRESSION DEFAULT_COMPRESSION DEFAULT 0,
    conversion_time STRING NULL ENCODING AUTO_ENCODING COMPRESSION DEFAULT_COMPRESSION DEFAULT '',
    PRIMARY KEY (reminder_day,shop_id,node_type,tid,subnick,buyer_nick,create_time,task_id,task_name)
) 
PARTITION BY HASH (shop_id) PARTITIONS 4,
RANGE (reminder_day) (
    PARTITION 20210807<=VALUES<20210808,
    PARTITION 20210808<=VALUES<20210809,
    PARTITION 20210809<=VALUES<20210810
) 
STORED AS KUDU TBLPROPERTIES (
    'kudu.master_addresses' = 'v1mini-bigdata-002,v1mini-bigdata-003,mini-bigdata-004'
)

INSERT INTO tmp.reminder_order_kudu_bck 
SELECT * FROM tmp.reminder_order_kudu
WHERE reminder_day>=20210807

DROP TABLE tmp.reminder_order_kudu
ALTER TABLE tmp.reminder_order_kudu_bck RENAME TO tmp.reminder_order_kudu




CREATE TABLE tmp.test_kudu_source_tbl(
    shop_id STRING NOT NULL ENCODING AUTO_ENCODING COMPRESSION DEFAULT_COMPRESSION,
    snick STRING NOT NULL ENCODING AUTO_ENCODING COMPRESSION DEFAULT_COMPRESSION,
    day INT NOT NULL ENCODING AUTO_ENCODING COMPRESSION DEFAULT_COMPRESSION,
    msg STRING NOT NULL ENCODING AUTO_ENCODING COMPRESSION DEFAULT_COMPRESSION,
    platform STRING NOT NULL ENCODING AUTO_ENCODING COMPRESSION DEFAULT_COMPRESSION,
    PRIMARY KEY (shop_id,snick,day)
)
PARTITION BY HASH (shop_id) PARTITIONS 16
STORED AS KUDU
TBLPROPERTIES ('kudu.master_addresses' = 'cdh0,cdh1,cdh2')

CREATE TABLE tmp.test_kudu_target_tbl(
    shop_id STRING NOT NULL ENCODING AUTO_ENCODING COMPRESSION DEFAULT_COMPRESSION,
    snick STRING NOT NULL ENCODING AUTO_ENCODING COMPRESSION DEFAULT_COMPRESSION,
    day INT NOT NULL ENCODING AUTO_ENCODING COMPRESSION DEFAULT_COMPRESSION,
    msg STRING NOT NULL ENCODING AUTO_ENCODING COMPRESSION DEFAULT_COMPRESSION,
    platform STRING NOT NULL ENCODING AUTO_ENCODING COMPRESSION DEFAULT_COMPRESSION,
    PRIMARY KEY (shop_id,snick,day)
)
PARTITION BY HASH (shop_id) PARTITIONS 16
STORED AS KUDU
TBLPROPERTIES ('kudu.master_addresses' = 'cdh0,cdh1,cdh2')

UPSERT INTO tmp.test_kudu_source_tbl
SELECT shop_id, snick, `day`, msg,platform
FROM tmp.chat_log_v1


DROP TABLE tmp.kudu_partition_test
CREATE TABLE tmp.kudu_partition_test (
  int_type INT,
  str_type STRING,
  PRIMARY KEY (int_type,str_type)
)
PARTITION BY HASH (str_type) PARTITIONS 4
STORED AS KUDU
TBLPROPERTIES ('kudu.master_addresses' = 'cdh0,cdh1,cdh2')




CREATE TABLE tmp.range_partition_test (
  day INT,
  str_type STRING,
  bigint_type BIGINT,
  PRIMARY KEY (day)
)
PARTITION BY HASH (day) PARTITIONS 4,
RANGE (day) (
    PARTITION 20210802<=VALUES<20210803,
    PARTITION 20210803<=VALUES<20210804
) STORED AS KUDU
TBLPROPERTIES ('kudu.master_addresses' = 'cdh0,cdh1,cdh2')


alter table tmp.range_partition_test drop if exists range partition 20210802<=VALUES<20210803
alter table tmp.range_partition_test add if not exists range partition 20210802<=VALUES<20210803

alter table tmp.range_partition_test drop if exists range partition 20210801<=VALUES<20210803
alter table tmp.range_partition_test add range partition 20210803<=VALUES<20210806




